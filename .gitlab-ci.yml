# SPDX-License-Identifier: MIT AND LicenseRef-Palimpsest-0.8
# GitLab CI/CD Pipeline for STATE

stages:
  - lint
  - test
  - build
  - docs

variables:
  GUILE_LOAD_PATH: "$CI_PROJECT_DIR/lib"

# Use minimal Debian for CI (Guix in container is complex for CI)
image: docker.io/library/debian:bookworm-slim

before_script:
  - apt-get update -qq
  - apt-get install -y -qq guile-3.0 graphviz

# Lint stage - check Scheme syntax
lint:
  stage: lint
  script:
    - |
      for f in lib/*.scm STATE.scm examples/*.scm; do
        echo "Checking $f..."
        guile -c "(load \"$f\")" || exit 1
      done
    - echo "All files OK"

# Also lint Guix files
lint-guix:
  stage: lint
  script:
    - guile -c '(load "channels.scm")' || echo "channels.scm requires Guix"
    - guile -c '(load "manifest.scm")' || echo "manifest.scm requires Guix"
    - guile -c '(load "guix.scm")' || echo "guix.scm requires Guix"

# Test stage - run tests
test:
  stage: test
  script:
    - guile -L lib -c '(use-modules (state)) (display "Modules loaded: ") (display (state-modules-loaded)) (newline)'
    - guile -L lib -c '(use-modules (state-core)) (display "state-core OK\n")'
    - guile -L lib -c '(use-modules (state-kanren)) (display "state-kanren OK\n")'
    - guile -L lib -c '(use-modules (state-graph)) (display "state-graph OK\n")'
    - guile -L lib -c '(use-modules (state-history)) (display "state-history OK\n")'

# Test minikanren fallback
test-kanren:
  stage: test
  script:
    - guile -L lib -c '(use-modules (state-kanren)) (if (minikanren-available?) (display "Using real minikanren\n") (display "Using fallback minikanren\n"))'

# Build stage - generate artifacts
build-graphs:
  stage: build
  script:
    - guile -L lib -c '(use-modules (state) (state-graph)) (load "examples/example-state.scm") (display (generate-dot state))' > dependency-graph.dot
    - guile -L lib -c '(use-modules (state) (state-graph)) (load "examples/example-state.scm") (display (generate-mermaid state))' > dependency-graph.mmd
    - dot -Tsvg dependency-graph.dot -o dependency-graph.svg
  artifacts:
    paths:
      - dependency-graph.dot
      - dependency-graph.mmd
      - dependency-graph.svg
    expire_in: 1 week

# Documentation stage
pages:
  stage: docs
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq asciidoctor
  script:
    - mkdir -p public
    - asciidoctor README.adoc -o public/index.html
    - asciidoctor USAGE.adoc -o public/usage.html
    - asciidoctor CONTRIBUTING.adoc -o public/contributing.html
    - asciidoctor GOVERNANCE.adoc -o public/governance.html
    - asciidoctor CODE_OF_CONDUCT.adoc -o public/code-of-conduct.html
    - asciidoctor SECURITY.adoc -o public/security.html
    - asciidoctor CHANGELOG.adoc -o public/changelog.html
    - asciidoctor PROJECT-STATUS.adoc -o public/status.html
    - asciidoctor MAINTAINERS.adoc -o public/maintainers.html
  artifacts:
    paths:
      - public
  only:
    - main
    - master
