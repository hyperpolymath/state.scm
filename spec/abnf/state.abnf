; ============================================================
; STATE Format - Augmented Backus-Naur Form (ABNF) Grammar
; ============================================================
;
; SPDX-License-Identifier: MIT AND LicenseRef-Palimpsest-0.8
; Copyright (c) 2025 Jonathan D.A. Jewell
;
; This grammar defines the STATE (Stateful Context Tracking Engine)
; file format for AI conversation checkpoint persistence.
;
; Reference: RFC 5234 (ABNF), RFC 7405 (Case-Sensitive Strings)
;
; ============================================================

; ------------------------------------------------------------
; Top-Level Structure
; ------------------------------------------------------------

state-file      = *comment state-definition *comment

state-definition = "(" *WSP "define" WSP "state" CRLF
                   *WSP sexp-body
                   ")" CRLF

sexp-body       = "'(" sections ")"

sections        = metadata-section
                  user-section
                  session-section
                  focus-section
                  projects-section
                  [ critical-next-section ]
                  [ issues-section ]
                  [ questions-section ]
                  [ roadmap-section ]
                  [ history-section ]
                  [ files-created-section ]
                  [ files-modified-section ]
                  [ context-notes-section ]

; ------------------------------------------------------------
; Section Definitions
; ------------------------------------------------------------

metadata-section     = "(" "metadata" CRLF
                       pair-format-version
                       pair-schema-version
                       pair-created-at
                       pair-last-updated
                       pair-generator
                       ")"

user-section         = "(" "user" CRLF
                       pair-name
                       pair-roles
                       [ preferences-block ]
                       ")"

session-section      = "(" "session" CRLF
                       pair-conversation-id
                       pair-started-at
                       pair-messages-used
                       pair-messages-remaining
                       pair-token-limit-reached
                       ")"

focus-section        = "(" "focus" CRLF
                       pair-current-project
                       pair-current-phase
                       pair-deadline
                       pair-blocking-projects
                       ")"

projects-section     = "(" "projects" CRLF
                       *project-entry
                       ")"

critical-next-section = "(" "critical-next" CRLF
                        string-list
                        ")"

issues-section       = "(" "issues" CRLF
                       *issue-entry
                       ")"

questions-section    = "(" "questions" CRLF
                       *question-entry
                       ")"

roadmap-section      = "(" "roadmap" CRLF
                       *roadmap-entry
                       ")"

history-section      = "(" "history" CRLF
                       snapshots-block
                       ")"

files-created-section  = "(" "files-created-this-session" CRLF
                         string-list
                         ")"

files-modified-section = "(" "files-modified-this-session" CRLF
                         string-list
                         ")"

context-notes-section  = "(" "context-notes" *WSP "." *WSP string ")"

; ------------------------------------------------------------
; Project Entry Structure
; ------------------------------------------------------------

project-entry   = "(" "(" pair-project-name
                       pair-status
                       pair-completion
                       pair-category
                       pair-phase
                       pair-dependencies
                       pair-blockers
                       pair-next
                       pair-chat-reference
                       [ pair-notes ]
                       ")" ")"

; ------------------------------------------------------------
; Issue Entry Structure
; ------------------------------------------------------------

issue-entry     = "(" "(" pair-id
                       pair-severity
                       pair-title
                       pair-description
                       pair-workaround
                       pair-issue-status
                       ")" ")"

; ------------------------------------------------------------
; Question Entry Structure
; ------------------------------------------------------------

question-entry  = "(" "(" pair-id
                       pair-priority
                       pair-question
                       pair-context
                       pair-options
                       ")" ")"

; ------------------------------------------------------------
; Roadmap Entry Structure
; ------------------------------------------------------------

roadmap-entry   = "(" "(" pair-roadmap-phase
                       pair-roadmap-status
                       pair-goals
                       ")" ")"

; ------------------------------------------------------------
; History/Snapshots Structure
; ------------------------------------------------------------

snapshots-block = "(" "snapshots" CRLF
                  *snapshot-entry
                  ")"

snapshot-entry  = "(" "(" pair-timestamp
                       snapshot-projects
                       ")" ")"

snapshot-projects = "(" "projects" CRLF
                    *snapshot-project-entry
                    ")"

snapshot-project-entry = "(" "(" pair-project-name
                              pair-completion
                              ")" ")"

; ------------------------------------------------------------
; Preferences Block
; ------------------------------------------------------------

preferences-block = "(" "preferences" CRLF
                    pair-languages-preferred
                    pair-languages-avoid
                    pair-tools-preferred
                    pair-values
                    ")"

; ------------------------------------------------------------
; Key-Value Pair Definitions
; ------------------------------------------------------------

; Metadata pairs
pair-format-version    = "(" "format-version" *WSP "." *WSP semver ")"
pair-schema-version    = "(" "schema-version" *WSP "." *WSP date-string ")"
pair-created-at        = "(" "created-at" *WSP "." *WSP iso-datetime ")"
pair-last-updated      = "(" "last-updated" *WSP "." *WSP iso-datetime ")"
pair-generator         = "(" "generator" *WSP "." *WSP string ")"

; User pairs
pair-name              = "(" "name" *WSP "." *WSP string ")"
pair-roles             = "(" "roles" *WSP "." *WSP string-list ")"

; Preference pairs
pair-languages-preferred = "(" "languages-preferred" *WSP "." *WSP string-list ")"
pair-languages-avoid     = "(" "languages-avoid" *WSP "." *WSP string-list ")"
pair-tools-preferred     = "(" "tools-preferred" *WSP "." *WSP string-list ")"
pair-values              = "(" "values" *WSP "." *WSP string-list ")"

; Session pairs
pair-conversation-id     = "(" "conversation-id" *WSP "." *WSP string ")"
pair-started-at          = "(" "started-at" *WSP "." *WSP iso-datetime ")"
pair-messages-used       = "(" "messages-used" *WSP "." *WSP integer ")"
pair-messages-remaining  = "(" "messages-remaining" *WSP "." *WSP integer ")"
pair-token-limit-reached = "(" "token-limit-reached" *WSP "." *WSP boolean ")"

; Focus pairs
pair-current-project     = "(" "current-project" *WSP "." *WSP string ")"
pair-current-phase       = "(" "current-phase" *WSP "." *WSP string ")"
pair-deadline            = "(" "deadline" *WSP "." *WSP ( iso-datetime / "#f" ) ")"
pair-blocking-projects   = "(" "blocking-projects" *WSP "." *WSP string-list ")"

; Project pairs
pair-project-name        = "(" "name" *WSP "." *WSP string ")"
pair-status              = "(" "status" *WSP "." *WSP project-status ")"
pair-completion          = "(" "completion" *WSP "." *WSP percentage ")"
pair-category            = "(" "category" *WSP "." *WSP string ")"
pair-phase               = "(" "phase" *WSP "." *WSP string ")"
pair-dependencies        = "(" "dependencies" *WSP "." *WSP string-list ")"
pair-blockers            = "(" "blockers" *WSP "." *WSP string-list ")"
pair-next                = "(" "next" *WSP "." *WSP string-list ")"
pair-chat-reference      = "(" "chat-reference" *WSP "." *WSP ( string / "#f" ) ")"
pair-notes               = "(" "notes" *WSP "." *WSP string ")"

; Issue pairs
pair-id                  = "(" "id" *WSP "." *WSP string ")"
pair-severity            = "(" "severity" *WSP "." *WSP severity-level ")"
pair-title               = "(" "title" *WSP "." *WSP string ")"
pair-description         = "(" "description" *WSP "." *WSP string ")"
pair-workaround          = "(" "workaround" *WSP "." *WSP string ")"
pair-issue-status        = "(" "status" *WSP "." *WSP issue-status ")"

; Question pairs
pair-priority            = "(" "priority" *WSP "." *WSP priority-level ")"
pair-question            = "(" "question" *WSP "." *WSP string ")"
pair-context             = "(" "context" *WSP "." *WSP string ")"
pair-options             = "(" "options" *WSP "." *WSP string-list ")"

; Roadmap pairs
pair-roadmap-phase       = "(" "phase" *WSP "." *WSP string ")"
pair-roadmap-status      = "(" "status" *WSP "." *WSP roadmap-status ")"
pair-goals               = "(" "goals" *WSP "." *WSP string-list ")"

; History pairs
pair-timestamp           = "(" "timestamp" *WSP "." *WSP iso-datetime ")"

; ------------------------------------------------------------
; Value Types
; ------------------------------------------------------------

; Semantic Version (X.Y.Z or X.Y)
semver          = DQUOTE major "." minor [ "." patch ] DQUOTE
major           = 1*DIGIT
minor           = 1*DIGIT
patch           = 1*DIGIT

; Date string (YYYY-MM-DD)
date-string     = DQUOTE 4DIGIT "-" 2DIGIT "-" 2DIGIT DQUOTE

; ISO 8601 DateTime
iso-datetime    = DQUOTE date "T" time timezone DQUOTE
date            = 4DIGIT "-" 2DIGIT "-" 2DIGIT
time            = 2DIGIT ":" 2DIGIT ":" 2DIGIT
timezone        = "Z" / ( ("+" / "-") 2DIGIT ":" 2DIGIT )

; Percentage (0-100)
percentage      = 1*3DIGIT  ; 0-100, semantically constrained

; Integer
integer         = [ "-" ] 1*DIGIT

; Boolean (Scheme format)
boolean         = "#t" / "#f"

; String (double-quoted, with escapes)
string          = DQUOTE *( string-char / escape-seq ) DQUOTE
string-char     = %x20-21 / %x23-5B / %x5D-7E / UTF8-char
escape-seq      = "\" ( DQUOTE / "\" / "n" / "r" / "t" )
UTF8-char       = %xC2-DF %x80-BF /
                  %xE0 %xA0-BF %x80-BF /
                  %xE1-EC %x80-BF %x80-BF /
                  %xED %x80-9F %x80-BF /
                  %xEE-EF %x80-BF %x80-BF /
                  %xF0 %x90-BF %x80-BF %x80-BF /
                  %xF1-F3 %x80-BF %x80-BF %x80-BF /
                  %xF4 %x80-8F %x80-BF %x80-BF

; String list
string-list     = "(" *( *WSP string *WSP ) ")"

; ------------------------------------------------------------
; Enumerations
; ------------------------------------------------------------

; Project status values
project-status  = DQUOTE (
                  "in-progress" /
                  "blocked" /
                  "paused" /
                  "complete" /
                  "abandoned"
                  ) DQUOTE

; Issue severity levels
severity-level  = DQUOTE (
                  "critical" /
                  "high" /
                  "medium" /
                  "low" /
                  "info"
                  ) DQUOTE

; Issue status values
issue-status    = DQUOTE (
                  "open" /
                  "documented" /
                  "in-progress" /
                  "resolved" /
                  "wont-fix" /
                  "planned-for-" 1*ALPHA  ; e.g., "planned-for-phase-3"
                  ) DQUOTE

; Priority levels
priority-level  = DQUOTE (
                  "critical" /
                  "high" /
                  "medium" /
                  "low"
                  ) DQUOTE

; Roadmap status values
roadmap-status  = DQUOTE (
                  "complete" /
                  "current" /
                  "next" /
                  "future" /
                  "vision"
                  ) DQUOTE

; ------------------------------------------------------------
; Comments (Scheme-style)
; ------------------------------------------------------------

comment         = ";" *( VCHAR / WSP ) CRLF
block-comment   = "#|" *( %x00-7F ) "|#"

; ------------------------------------------------------------
; Core ABNF Rules (RFC 5234)
; ------------------------------------------------------------

ALPHA           = %x41-5A / %x61-7A   ; A-Z / a-z
DIGIT           = %x30-39             ; 0-9
DQUOTE          = %x22                ; "
WSP             = SP / HTAB
SP              = %x20
HTAB            = %x09
CRLF            = CR LF / LF          ; Flexible line endings
CR              = %x0D
LF              = %x0A
VCHAR           = %x21-7E             ; Visible characters

; ============================================================
; END OF GRAMMAR
; ============================================================
